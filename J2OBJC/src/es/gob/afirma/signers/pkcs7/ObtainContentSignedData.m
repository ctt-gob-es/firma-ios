//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/desarrolloabamobile/Documents/JAVA/pades-ios/src/main/java/es/gob/afirma/signers/pkcs7/ObtainContentSignedData.java
//

#include "IOSPrimitiveArray.h"
#include "J2ObjC_source.h"
#include "es/gob/afirma/core/AOInvalidFormatException.h"
#include "es/gob/afirma/signers/pkcs7/AOAlgorithmID.h"
#include "es/gob/afirma/signers/pkcs7/ObtainContentSignedData.h"
#include "java/lang/Exception.h"
#include "java/lang/Throwable.h"
#include "java/util/Enumeration.h"
#include "java/util/logging/Logger.h"
#include "org/spongycastle/asn1/ASN1Encodable.h"
#include "org/spongycastle/asn1/ASN1InputStream.h"
#include "org/spongycastle/asn1/ASN1ObjectIdentifier.h"
#include "org/spongycastle/asn1/ASN1Primitive.h"
#include "org/spongycastle/asn1/ASN1Sequence.h"
#include "org/spongycastle/asn1/ASN1Set.h"
#include "org/spongycastle/asn1/ASN1TaggedObject.h"
#include "org/spongycastle/asn1/DEROctetString.h"
#include "org/spongycastle/asn1/DERSet.h"
#include "org/spongycastle/asn1/cms/CMSAttributes.h"
#include "org/spongycastle/asn1/cms/ContentInfo.h"
#include "org/spongycastle/asn1/cms/SignedData.h"
#include "org/spongycastle/asn1/cms/SignerInfo.h"
#include "org/spongycastle/asn1/pkcs/PKCSObjectIdentifiers.h"
#include "org/spongycastle/asn1/x509/AlgorithmIdentifier.h"

#if !__has_feature(objc_arc)
#error "es/gob/afirma/signers/pkcs7/ObtainContentSignedData must be compiled with ARC (-fobjc-arc)"
#endif

@interface EsGobAfirmaSignersPkcs7ObtainContentSignedData ()

- (instancetype)init;

@end

inline JavaUtilLoggingLogger *EsGobAfirmaSignersPkcs7ObtainContentSignedData_get_LOGGER(void);
static JavaUtilLoggingLogger *EsGobAfirmaSignersPkcs7ObtainContentSignedData_LOGGER;
J2OBJC_STATIC_FIELD_OBJ_FINAL(EsGobAfirmaSignersPkcs7ObtainContentSignedData, LOGGER, JavaUtilLoggingLogger *)

__attribute__((unused)) static void EsGobAfirmaSignersPkcs7ObtainContentSignedData_init(EsGobAfirmaSignersPkcs7ObtainContentSignedData *self);

__attribute__((unused)) static EsGobAfirmaSignersPkcs7ObtainContentSignedData *new_EsGobAfirmaSignersPkcs7ObtainContentSignedData_init(void) NS_RETURNS_RETAINED;

__attribute__((unused)) static EsGobAfirmaSignersPkcs7ObtainContentSignedData *create_EsGobAfirmaSignersPkcs7ObtainContentSignedData_init(void);

#line 1 "/Users/desarrolloabamobile/Documents/JAVA/pades-ios/src/main/java/es/gob/afirma/signers/pkcs7/ObtainContentSignedData.java"

J2OBJC_INITIALIZED_DEFN(EsGobAfirmaSignersPkcs7ObtainContentSignedData)


#line 34
@implementation EsGobAfirmaSignersPkcs7ObtainContentSignedData

J2OBJC_IGNORE_DESIGNATED_BEGIN

#line 36
- (instancetype)init {
  EsGobAfirmaSignersPkcs7ObtainContentSignedData_init(self);
  return self;
}
J2OBJC_IGNORE_DESIGNATED_END


#line 48
+ (IOSByteArray *)obtainDataWithByteArray:(IOSByteArray *)data {
  return EsGobAfirmaSignersPkcs7ObtainContentSignedData_obtainDataWithByteArray_(data);
}


#line 102
+ (IOSByteArray *)obtainMessageDigestWithByteArray:(IOSByteArray *)signature
                                      withNSString:(NSString *)digestAlgorithm {
  return EsGobAfirmaSignersPkcs7ObtainContentSignedData_obtainMessageDigestWithByteArray_withNSString_(signature, digestAlgorithm);
}

+ (const J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { NULL, NULL, 0x2, -1, -1, -1, -1, -1, -1 },
    { NULL, "[B", 0x9, 0, 1, 2, -1, -1, -1 },
    { NULL, "[B", 0x9, 3, 4, 5, -1, -1, -1 },
  };
  #pragma clang diagnostic push
  #pragma clang diagnostic ignored "-Wobjc-multiple-method-names"
  #pragma clang diagnostic ignored "-Wundeclared-selector"
  methods[0].selector = @selector(init);
  methods[1].selector = @selector(obtainDataWithByteArray:);
  methods[2].selector = @selector(obtainMessageDigestWithByteArray:withNSString:);
  #pragma clang diagnostic pop
  static const J2ObjcFieldInfo fields[] = {
    { "LOGGER", "LJavaUtilLoggingLogger;", .constantValue.asLong = 0, 0x1a, -1, 6, -1, -1 },
  };
  static const void *ptrTable[] = { "obtainData", "[B", "LEsGobAfirmaCoreAOInvalidFormatException;", "obtainMessageDigest", "[BLNSString;", "LJavaIoIOException;", &EsGobAfirmaSignersPkcs7ObtainContentSignedData_LOGGER };
  static const J2ObjcClassInfo _EsGobAfirmaSignersPkcs7ObtainContentSignedData = { "ObtainContentSignedData", "es.gob.afirma.signers.pkcs7", ptrTable, methods, fields, 7, 0x11, 3, 1, -1, -1, -1, -1, -1 };
  return &_EsGobAfirmaSignersPkcs7ObtainContentSignedData;
}

+ (void)initialize {
  if (self == [EsGobAfirmaSignersPkcs7ObtainContentSignedData class]) {
    EsGobAfirmaSignersPkcs7ObtainContentSignedData_LOGGER = JavaUtilLoggingLogger_getLoggerWithNSString_(
#line 40
    @"es.gob.afirma");
    J2OBJC_SET_INITIALIZED(EsGobAfirmaSignersPkcs7ObtainContentSignedData)
  }
}

@end


#line 36
void EsGobAfirmaSignersPkcs7ObtainContentSignedData_init(EsGobAfirmaSignersPkcs7ObtainContentSignedData *self) {
  NSObject_init(self);
}


#line 36
EsGobAfirmaSignersPkcs7ObtainContentSignedData *new_EsGobAfirmaSignersPkcs7ObtainContentSignedData_init() {
  J2OBJC_NEW_IMPL(EsGobAfirmaSignersPkcs7ObtainContentSignedData, init)
}


#line 36
EsGobAfirmaSignersPkcs7ObtainContentSignedData *create_EsGobAfirmaSignersPkcs7ObtainContentSignedData_init() {
  J2OBJC_CREATE_IMPL(EsGobAfirmaSignersPkcs7ObtainContentSignedData, init)
}


#line 48
IOSByteArray *EsGobAfirmaSignersPkcs7ObtainContentSignedData_obtainDataWithByteArray_(IOSByteArray *data) {
  EsGobAfirmaSignersPkcs7ObtainContentSignedData_initialize();
  
#line 49
  IOSByteArray *contenido = nil;
  
#line 51
  OrgSpongycastleAsn1ASN1ObjectIdentifier *doi;
  OrgSpongycastleAsn1ASN1TaggedObject *doj;
  @try {
    
#line 55
    OrgSpongycastleAsn1ASN1Sequence *dsq;
    {
      OrgSpongycastleAsn1ASN1InputStream *is = new_OrgSpongycastleAsn1ASN1InputStream_initWithByteArray_(data);
      JavaLangThrowable *__primaryException1 = nil;
      
#line 56
      @try {
        
#line 59
        dsq = (OrgSpongycastleAsn1ASN1Sequence *) cast_chk([is readObject], [OrgSpongycastleAsn1ASN1Sequence class]);
      }
      @catch (JavaLangThrowable *e) {
        __primaryException1 = e;
        @throw e;
      }
      @finally {
        if (is != nil) {
          if (__primaryException1 != nil) {
            @try {
              [is close];
            }
            @catch (JavaLangThrowable *e) {
              [__primaryException1 addSuppressedWithJavaLangThrowable:e];
            }
          }
          else {
            [is close];
          }
        }
      }
    }
    
#line 62
    id<JavaUtilEnumeration> e = [((OrgSpongycastleAsn1ASN1Sequence *) nil_chk(dsq)) getObjects];
    
#line 64
    doi = (OrgSpongycastleAsn1ASN1ObjectIdentifier *) cast_chk([((id<JavaUtilEnumeration>) nil_chk(e)) nextElement], [OrgSpongycastleAsn1ASN1ObjectIdentifier class]);
    
#line 66
    doj = (OrgSpongycastleAsn1ASN1TaggedObject *) cast_chk([e nextElement], [OrgSpongycastleAsn1ASN1TaggedObject class]);
  }
  @catch (JavaLangException *e) {
    @throw new_EsGobAfirmaCoreAOInvalidFormatException_initWithNSString_withJavaLangException_(JreStrcat("$@", @"Error al parsear la firma ASN.1: ", e), e);
  }
  
#line 73
  if ([((OrgSpongycastleAsn1ASN1ObjectIdentifier *) nil_chk(doi)) isEqual:JreLoadStatic(OrgSpongycastleAsn1PkcsPKCSObjectIdentifiers, signedData)]) {
    
#line 75
    OrgSpongycastleAsn1CmsSignedData *sd = OrgSpongycastleAsn1CmsSignedData_getInstanceWithId_([((OrgSpongycastleAsn1ASN1TaggedObject *) nil_chk(doj)) getObject]);
    OrgSpongycastleAsn1CmsContentInfo *ci = [((OrgSpongycastleAsn1CmsSignedData *) nil_chk(sd)) getEncapContentInfo];
    
#line 78
    if ([((OrgSpongycastleAsn1CmsContentInfo *) nil_chk(ci)) getContent] != nil) {
      contenido = [((OrgSpongycastleAsn1DEROctetString *) nil_chk(((OrgSpongycastleAsn1DEROctetString *) cast_chk([ci getContent], [OrgSpongycastleAsn1DEROctetString class])))) getOctets];
    }
    else {
      [((JavaUtilLoggingLogger *) nil_chk(EsGobAfirmaSignersPkcs7ObtainContentSignedData_LOGGER)) infoWithNSString:@"No existe contenido en esta firma. Se devolvera null"];
    }
  }
  else {
    [((JavaUtilLoggingLogger *) nil_chk(EsGobAfirmaSignersPkcs7ObtainContentSignedData_LOGGER)) warningWithNSString:@"No se puede obtener el contenido de esta firma."];
  }
  
#line 89
  return contenido;
}


#line 102
IOSByteArray *EsGobAfirmaSignersPkcs7ObtainContentSignedData_obtainMessageDigestWithByteArray_withNSString_(IOSByteArray *signature, NSString *digestAlgorithm) {
  EsGobAfirmaSignersPkcs7ObtainContentSignedData_initialize();
  OrgSpongycastleAsn1ASN1Sequence *dsq;
  {
    OrgSpongycastleAsn1ASN1InputStream *is = new_OrgSpongycastleAsn1ASN1InputStream_initWithByteArray_(signature);
    JavaLangThrowable *__primaryException1 = nil;
    
#line 105
    @try {
      
#line 108
      dsq = (OrgSpongycastleAsn1ASN1Sequence *) cast_chk([is readObject], [OrgSpongycastleAsn1ASN1Sequence class]);
    }
    @catch (JavaLangThrowable *e) {
      __primaryException1 = e;
      @throw e;
    }
    @finally {
      if (is != nil) {
        if (__primaryException1 != nil) {
          @try {
            [is close];
          }
          @catch (JavaLangThrowable *e) {
            [__primaryException1 addSuppressedWithJavaLangThrowable:e];
          }
        }
        else {
          [is close];
        }
      }
    }
  }
  
#line 111
  id<JavaUtilEnumeration> e = [((OrgSpongycastleAsn1ASN1Sequence *) nil_chk(dsq)) getObjects];
  
#line 114
  OrgSpongycastleAsn1ASN1ObjectIdentifier *doi = (OrgSpongycastleAsn1ASN1ObjectIdentifier *) cast_chk([((id<JavaUtilEnumeration>) nil_chk(e)) nextElement], [OrgSpongycastleAsn1ASN1ObjectIdentifier class]);
  
#line 117
  if (![((OrgSpongycastleAsn1ASN1ObjectIdentifier *) nil_chk(doi)) isEqual:JreLoadStatic(OrgSpongycastleAsn1PkcsPKCSObjectIdentifiers, signedData)]) {
    [((JavaUtilLoggingLogger *) nil_chk(EsGobAfirmaSignersPkcs7ObtainContentSignedData_LOGGER)) warningWithNSString:@"No se puede obtener el contenido de esta firma."];
    return nil;
  }
  
#line 123
  OrgSpongycastleAsn1ASN1TaggedObject *doj = (OrgSpongycastleAsn1ASN1TaggedObject *) cast_chk([e nextElement], [OrgSpongycastleAsn1ASN1TaggedObject class]);
  OrgSpongycastleAsn1CmsSignedData *sd = OrgSpongycastleAsn1CmsSignedData_getInstanceWithId_([((OrgSpongycastleAsn1ASN1TaggedObject *) nil_chk(doj)) getObject]);
  OrgSpongycastleAsn1ASN1Set *signerInfosSd = [((OrgSpongycastleAsn1CmsSignedData *) nil_chk(sd)) getSignerInfos];
  
#line 127
  IOSByteArray *messageDigest = nil;
  
#line 129
  for (jint i = 0; i < [((OrgSpongycastleAsn1ASN1Set *) nil_chk(signerInfosSd)) size]; i++) {
    OrgSpongycastleAsn1CmsSignerInfo *si = OrgSpongycastleAsn1CmsSignerInfo_getInstanceWithId_([signerInfosSd getObjectAtWithInt:i]);
    OrgSpongycastleAsn1X509AlgorithmIdentifier *algHash = [((OrgSpongycastleAsn1CmsSignerInfo *) nil_chk(si)) getDigestAlgorithm];
    if ([((NSString *) nil_chk([((OrgSpongycastleAsn1ASN1ObjectIdentifier *) nil_chk([((OrgSpongycastleAsn1X509AlgorithmIdentifier *) nil_chk(algHash)) getAlgorithm])) description])) isEqual:EsGobAfirmaSignersPkcs7AOAlgorithmID_getOIDWithNSString_(digestAlgorithm)]) {
      OrgSpongycastleAsn1ASN1Set *signedAttrib = [si getAuthenticatedAttributes];
      for (jint s = 0; s < [((OrgSpongycastleAsn1ASN1Set *) nil_chk(signedAttrib)) size]; s++) {
        OrgSpongycastleAsn1ASN1Sequence *elemento = (OrgSpongycastleAsn1ASN1Sequence *) cast_chk([signedAttrib getObjectAtWithInt:s], [OrgSpongycastleAsn1ASN1Sequence class]);
        OrgSpongycastleAsn1ASN1ObjectIdentifier *oids = (OrgSpongycastleAsn1ASN1ObjectIdentifier *) cast_chk([((OrgSpongycastleAsn1ASN1Sequence *) nil_chk(elemento)) getObjectAtWithInt:0], [OrgSpongycastleAsn1ASN1ObjectIdentifier class]);
        if ([((NSString *) nil_chk([((OrgSpongycastleAsn1ASN1ObjectIdentifier *) nil_chk(JreLoadStatic(OrgSpongycastleAsn1CmsCMSAttributes, messageDigest))) getId])) isEqual:[((OrgSpongycastleAsn1ASN1ObjectIdentifier *) nil_chk(oids)) description]]) {
          OrgSpongycastleAsn1DERSet *derSetHash = (OrgSpongycastleAsn1DERSet *) cast_chk([elemento getObjectAtWithInt:1], [OrgSpongycastleAsn1DERSet class]);
          OrgSpongycastleAsn1DEROctetString *derHash = (OrgSpongycastleAsn1DEROctetString *) cast_chk([((OrgSpongycastleAsn1DERSet *) nil_chk(derSetHash)) getObjectAtWithInt:0], [OrgSpongycastleAsn1DEROctetString class]);
          messageDigest = [((OrgSpongycastleAsn1DEROctetString *) nil_chk(derHash)) getOctets];
          break;
        }
      }
      if (messageDigest != nil) {
        break;
      }
    }
  }
  if (messageDigest == nil) {
    [((JavaUtilLoggingLogger *) nil_chk(EsGobAfirmaSignersPkcs7ObtainContentSignedData_LOGGER)) warningWithNSString:JreStrcat("$$", @"No se ha encontrado en la firma una huella digital generada con el algoritmo: ", digestAlgorithm)];
  }
  return messageDigest;
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(EsGobAfirmaSignersPkcs7ObtainContentSignedData)
